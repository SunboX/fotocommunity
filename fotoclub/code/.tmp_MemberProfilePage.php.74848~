<?php


class MemberProfilePage extends Page
{
	function requireDefaultRecords()
	{
		if(!DataObject::get('MemberProfilePage'))
		{
			$page = new MemberProfilePage();
			$page->Title = 'Profil bearbeiten';
			//$page->URLSegment = 'profil';
			$page->write();
			$page->doPublish();
		}
	}	
}

class MemberProfilePage_Controller extends Page_Controller
{
	function init()
	{
		//Requirements::themedCSS('Profile');
		$member = $this->Member() ? $this->Member() : null;
		$nicknameText = ($member) ? ($member->Nickname . '\'s ') : '';
		
		$this->Title = $nicknameText . ' Profil';
		
		parent::init();
 	}
	
	public function edit()
	{
		if(Permission::check('ADMIN') || (is_numeric($this->urlParams['ID']) && $this->urlParams['ID'] == Member::currentMember()->ID))
		{
			return array('EditProfileForm' => $this->EditProfileForm());
		}
		Director::redirect('show');
	}
	
	public function show()
	{
		return array('CurrentProfile' => $this->Member());
	}
	
	function EditProfileForm()
	{
		$member = $this->Member();

		$fields = singleton('Member')->getEditProfileFields();
		
		$fields->push(new HtmlEditorField('Signature', 'Signature'));
		
		$fields->push(new HiddenField('ID'));

		$form = new Form($this, 'EditProfileForm', $fields,
			new FieldSet(new FormAction('dosave', 'Ã„nderungen Speichern')),
			new RequiredFields('Nickname')
		);

		if($member && $member->hasMethod('canEdit') && $member->canEdit())
		{
			$member->Password = '';
			$form->loadDataFrom($member);
			return $form;
		}
		else
		{
			return null;
		}
	}
	
	function dosave($data, $form)
	{
		$member = DataObject::get_by_id('Member', $data['ID']);
		$SQL_email = Convert::raw2sql($data['Email']);
		
		// An existing member may have the requested email that doesn't belong to the
		// person who is editing their profile - if so, throw an error
		$existingMember = DataObject::get_one('Member', "Email = '$SQL_email'");
		if($existingMember)
		{
			if($existingMember->ID != $member->ID)
			{
  				$form->addErrorMessage('Blurb', 'Sorry, that email address already exists. Please choose another.', 'bad');
				
  				Director::redirectBack();
  				return;
			}
		}
		
		if($member->canEdit())
		{
			if(!empty($data['Password']) && !empty($data['ConfirmPassword']))
			{
				if($data['Password'] == $data['ConfirmPassword'])
				{
					$member->Password = $data['Password'];
				}
				else
				{
					$form->addErrorMessage('Blurb', 'PASSNOTMATCH', 'bad');
					Director::redirectBack();
				}
			}
			else
			{
				$form->dataFieldByName('Password')->setValue($member->Password);
			}
		}


		$nicknameCheck = DataObject::get_one('Member',
			"`Nickname` = '{$data['Nickname']}' AND `Member`.`ID` != '{$member->ID}'");

		if($nicknameCheck)
		{
			$form->addErrorMessage('Blurb', 'NICKNAMEEXISTS', "bad");
			Director::redirectBack();
			return;
		}

		$form->saveInto($member);
		$member->write();
		
		Director::redirect('profil/show/' . $data['ID']);
	}
	
 	function Member()
	{
 		$member = null;
 		
		if(is_numeric($this->urlParams['ID']))
		{
			$member = DataObject::get_by_id('Member', $this->urlParams['ID']);
		}
		else
		{
			$member = Member::currentUser();
		}
		
		return $member;
	}
	
	function MetaTags($includeTitle = true)
	{
		$tags = '';
		$Title = 'Profil bearbeiten';
		if(Director::urlParam('Action') == 'register')
		{ 
			$Title = 'Registration';
		}
		if($includeTitle == true)
		{
			$tags .= '<title>' . $Title . '</title>' ."\n";
		}

		return $tags;
	}
}

?>